<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ODFクラスタの拡張 :: ODF Workshop</title>
    <link rel="canonical" href="https://tutsunom.github.io/odf-workshop/odf-workshop/07-expand.html">
    <link rel="prev" href="06-mcg.html">
    <link rel="next" href="08-monitoring.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://tutsunom.github.io/odf-workshop">ODF Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="odf-workshop" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">ODF Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="01-odf_deploy.html">ODF Operatorを使用したストレージのデプロイ</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-rbd_rwopvc.html">Ceph RBD volumeを使用するOCPアプリケーション</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-cephfs_rwxpvc.html">CephFS volumeを使用するOCPアプリケーション</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-clone_snapshot.html">PVCのクローンとスナップショット</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05-openshift_monitoring.html">OpenShift MonitoringでのODFの使用</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-mcg.html">Multi-Cloud Gateway</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="07-expand.html">ODFクラスタの拡張</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="08-monitoring.html">ODFのモニタリング</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="09-mustgather.html">must-gatherの使用</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="appendix-ceph.html">Appendix: Cephの概要</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">ODF Workshop</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">ODF Workshop</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">ODF Workshop</a></li>
    <li><a href="07-expand.html">ODFクラスタの拡張</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/tutsunom/odf-workshop/edit/master/documentation/modules/ROOT/pages/07-expand.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">ODFクラスタの拡張</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>ODFクラスタにストレージを追加することで、容量が追加されパフォーマンスが向上されます。<br>
このセクションでは、現在のストレージクラスタにODF Workerノードを追加する方法について説明します。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_workerノードを追加する"><a class="anchor" href="#_workerノードを追加する"></a>Workerノードを追加する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>現在のストレージクラスタにODF Workerノードを追加します。その後、次のサブセクションでODFクラスタを拡張して新しいノードにストレージをプロビジョニングする方法について説明します。</p>
</div>
<div class="paragraph">
<p>ノードを追加するには、<strong>MachineSet</strong> を追加するか、既存のODFノード用 <strong>MachieSet</strong> をスケールアップします。
このトレーニングでは、既存のODFノード用 <strong>MachineSet</strong> をスケールアップして、より多くのworker nodeを生成します。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
ODF Workerノードを追加するときは、既存のノードに十分なCPUやメモリがない場合などが挙げられます。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>現在のworkerocs <strong>MachineSet</strong> と <strong>Machine</strong> の数を確認してください。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get machinesets -n openshift-machine-api | egrep 'NAME|workerocs'</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                       DESIRED   CURRENT   READY   AVAILABLE   AGE
cluster-d6qlm-mbttv-workerocs-us-east-2a   1         1         1       1           32h
cluster-d6qlm-mbttv-workerocs-us-east-2b   1         1         1       1           32h
cluster-d6qlm-mbttv-workerocs-us-east-2c   1         1         1       1           32h</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドで、workerocs <strong>MachineSet</strong> をスケールアップしてみましょう。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get machinesets -n openshift-machine-api -o name | grep workerocs | xargs -n1 -t oc scale -n openshift-machine-api --replicas=2</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc scale -n openshift-machine-api --replicas=2 machineset.machine.openshift.io/cluster-d6qlm-mbttv-workerocs-us-east-2a
machineset.machine.openshift.io/cluster-d6qlm-mbttv-workerocs-us-east-2a scaled
oc scale -n openshift-machine-api --replicas=2 machineset.machine.openshift.io/cluster-d6qlm-mbttv-workerocs-us-east-2b
machineset.machine.openshift.io/cluster-d6qlm-mbttv-workerocs-us-east-2b scaled
oc scale -n openshift-machine-api --replicas=2 machineset.machine.openshift.io/cluster-d6qlm-mbttv-workerocs-us-east-2c
machineset.machine.openshift.io/cluster-d6qlm-mbttv-workerocs-us-east-2c scaled</code></pre>
</div>
</div>
<div class="paragraph">
<p>新しいWorkerノードが使用可能になるまで待ちます。全てのカラムで <code>2</code> と表示されるまで待ちましょう。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch "oc get machinesets -n openshift-machine-api | egrep 'NAME|workerocs'"</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span> を押すと終了できます。</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>workerocs <strong>MachineSet</strong> が3つのAZに無いOCPクラスタでは、最終的に6台のworkerocs <strong>Machine</strong> を持つように設定して下さい。</p>
</div>
<div class="listingblock console-output">
<div class="title"><code>us-east-2c</code> AZにのみworkerocs <strong>MachineSet</strong> がある場合の例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get machinesets -n openshift-machine-api -o name | grep workerocs | xargs -n1 -t oc scale -n openshift-machine-api --replicas=6

$ oc get machines -n openshift-machine-api | egrep 'NAME|workerocs'
NAME                                             PHASE     TYPE         REGION      ZONE         AGE
cluster-2mwq7-jls22-workerocs-us-east-2c-5cqzh   Running   m5.4xlarge   us-east-2   us-east-2c   3m13s
cluster-2mwq7-jls22-workerocs-us-east-2c-7hh5l   Running   m5.4xlarge   us-east-2   us-east-2c   3m13s
cluster-2mwq7-jls22-workerocs-us-east-2c-ch9ds   Running   m5.4xlarge   us-east-2   us-east-2c   6h2m
cluster-2mwq7-jls22-workerocs-us-east-2c-cqbkp   Running   m5.4xlarge   us-east-2   us-east-2c   3m13s
cluster-2mwq7-jls22-workerocs-us-east-2c-r5smx   Running   m5.4xlarge   us-east-2   us-east-2c   6h2m
cluster-2mwq7-jls22-workerocs-us-east-2c-scjvh   Running   m5.4xlarge   us-east-2   us-east-2c   6h2m

$ oc get machineset -n openshift-machine-api | egrep 'NAME|workerocs'
NAME                                       DESIRED   CURRENT   READY   AVAILABLE   AGE
cluster-2mwq7-jls22-workerocs-us-east-2c   6         6         6       6           6h3m</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>新しいノードが使用可能になったら、次のようにラベルを確認できます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
新しく追加したWorkerノードにも <code>cluster.ocs.openshift.io/openshift-storage=</code> ラベルは既に付けられています。これは <strong>MachineSet</strong> 自体にラベルの設定を行ったためで、新しく作られるノードにも自動的にラベルが付けられます。
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get nodes -l cluster.ocs.openshift.io/openshift-storage -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}'</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ip-10-0-142-148.us-east-2.compute.internal
ip-10-0-153-93.us-east-2.compute.internal
ip-10-0-173-143.us-east-2.compute.internal
ip-10-0-181-161.us-east-2.compute.internal
ip-10-0-201-210.us-east-2.compute.internal
ip-10-0-219-73.us-east-2.compute.internal</code></pre>
</div>
</div>
<div class="paragraph">
<p>ODFラベルが付いた新しいノードが作成できたので、次のステップでは、Cephクラスタにストレージを追加します。ODF Operatorは、ODFラベルの付いた新しいWorkerノードを優先してストレージを追加します。なぜなら、これらのノードにはまだODF Podがスケジュールされていないためです。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ストレージ容量を追加する"><a class="anchor" href="#_ストレージ容量を追加する"></a>ストレージ容量を追加する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このセクションでは、構成済みのODF Workerノードでストレージ容量とパフォーマンスを追加します。</p>
</div>
<div class="paragraph">
<p>前のセクションを実行した後は、6つのODF Workerノードが存在するはずです。</p>
</div>
<div class="paragraph">
<p>ストレージを追加するには、<strong>OpenShift Web Console</strong> に移動し、手順にしたがってODFストレージクラスタの概要を表示します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>左側のメニューから <strong>Operators</strong> &#8594; <strong>Installed Operators</strong> をクリックする</p>
</li>
<li>
<p><code>openshift-storage</code> Projectを選択する</p>
</li>
<li>
<p><code>OpenShift Data Foundation Operator</code> をクリックする</p>
</li>
<li>
<p>上部のナビゲーションバーで <code>Storage System</code> をクリックする</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/OCS4-OCP4-Storage-Cluster-overview-reachit.png" alt="OCS4 OCP4 Storage Cluster overview reachit">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>表示される <code>ocs-storagecluster-storagesystem</code> の右端にある3つのドットをクリックして、オプションメニューを表示する</p>
</li>
<li>
<p><code>Add Capacity</code> を選択し、新しいダイアログを開く</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/OCS4-add-capacity.png" alt="Add Capacity dialog">
</div>
<div class="title">Figure 1. Add Capacity dialog</div>
</div>
<div class="paragraph">
<p>StorageClassは <code>gp2</code> を選ぶ必要があります。また、<code>Raw Capacity</code> に表示される容量を拡張できます。ODFは三重でレプリカを取るため、<code>Raw Capacity</code> は希望する追加容量はの3倍の容量になります。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong><code>Raw Capacity</code> は最初にODFクラスタを構成した時点で選択したストレージ容量で決まるため、変更することはできません。</strong>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>設定が完了したら、 <strong>Add</strong> をクリックして続行します。ストレージクラスタのステータスが再び <code>Ready</code> になるまで変化します。</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
新しいOSD Podが <code>Running</code> の状態になるには5分以上かかる場合があります。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次のコマンドで、新しいOSD Podが追加されていることが分かります。新しいOSD Podが、新規に追加したODF worker nodeの上で動いていることに注目して下さい。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pod -o=custom-columns=NAME:.metadata.name,STATUS:.status.phase,NODE:.spec.nodeName -n openshift-storage | grep osd | grep -v prepare</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">rook-ceph-osd-0-7c9cb6fdd9-fwvxs                                  Running     ip-10-0-142-148.us-east-2.compute.internal
rook-ceph-osd-1-8568c7d4b4-7p8hs                                  Running     ip-10-0-219-73.us-east-2.compute.internal
rook-ceph-osd-2-67d878cd95-qpbkg                                  Running     ip-10-0-173-143.us-east-2.compute.internal
rook-ceph-osd-3-577c47b6b8-ffwg2                                  Running     ip-10-0-201-210.us-east-2.compute.internal
rook-ceph-osd-4-5d665b7497-cbqz5                                  Running     ip-10-0-153-93.us-east-2.compute.internal
rook-ceph-osd-5-6bf7684498-k24qb                                  Running     ip-10-0-181-161.us-east-2.compute.internal</code></pre>
</div>
</div>
<div class="paragraph">
<p>以上でODFクラスタを拡張することができました。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_新しいストレージを確認する"><a class="anchor" href="#_新しいストレージを確認する"></a>新しいストレージを確認する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>容量を追加し、OSD podの存在を確認したら、<strong>toolbox</strong> を使用して追加したストレージ容量を確認することができます。</p>
</div>
<div class="paragraph">
<p>まずは次のコマンドで toolbox Podに入ります。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">TOOLS_POD=$(oc get pods -n openshift-storage -l app=rook-ceph-tools -o name)
oc rsh -n openshift-storage $TOOLS_POD</code></pre>
</div>
</div>
<div class="paragraph">
<p>次にCephクラスタのステータスを確認します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ceph status</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sh-4.4$ ceph status
  cluster:
    id:     cbeb7c9d-2a30-4646-b5a6-72d5c1db914c
    health: HEALTH_OK

  services:
    mon: 3 daemons, quorum a,b,c (age 29h)
    mgr: a(active, since 29h)
    mds: 1/1 daemons up, 1 hot standby
    osd: 6 osds: 6 up (since 7m), 6 in (since 8m) <i class="conum" data-value="1"></i><b>(1)</b>

  data:
    volumes: 1/1 healthy
    pools:   4 pools, 289 pgs
    objects: 1.76k objects, 5.9 GiB
    usage:   18 GiB used, 12 TiB / 12 TiB avail <i class="conum" data-value="2"></i><b>(2)</b>
    pgs:     289 active+clean

  io:
    client:   0 B/s rd, 1 op/s rd, 0 op/s wr</code></pre>
</div>
</div>
<div class="paragraph">
<p>この出力から次のことがわかります。</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>現在合計6つのOSDを使用しているが、それらは <code>up</code> で <code>in</code> である。(つまり、OSDデーモンが実行されており、ストレージの領域として使用されている)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>利用可能な物理容量が6TiBから12TiBに増加している。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>これら以外にはCephステータスの出力は何も変わっていません。</p>
</div>
<div class="paragraph">
<p>続いて、Cephクラスタのトポロジーを確認します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ceph osd crush tree</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ID   CLASS  WEIGHT    TYPE NAME
 -1         12.00000  root default
 -5         12.00000      region us-east-2
 -4          4.00000          zone us-east-2a
-19          2.00000              host ocs-deviceset-gp2-1-data-1stbzz
  4    ssd   2.00000                  osd.4
 -3          2.00000              host ocs-deviceset-gp2-2-data-04xwqf
  0    ssd   2.00000                  osd.0
-14          4.00000          zone us-east-2b
-13          2.00000              host ocs-deviceset-gp2-0-data-0pdj4t
  2    ssd   2.00000                  osd.2
-21          2.00000              host ocs-deviceset-gp2-2-data-1q4qp5
  5    ssd   2.00000                  osd.5
-10          4.00000          zone us-east-2c
-17          2.00000              host ocs-deviceset-gp2-0-data-1dppqr
  3    ssd   2.00000                  osd.3
 -9          2.00000              host ocs-deviceset-gp2-1-data-0m5bzn
  1    ssd   2.00000                  osd.1</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Workerノードが追加されたことで、それぞれの <code>zone</code> の中で <code>host</code> が拡張されている。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ODFで構成されたCephクラスタでは、それぞれのPoolごとにCRUSHルールが設定されています。どのルールでもデフォルトは <code>zone</code> でデータを複製するように設定されていて、高い冗長性を保ち、追加前のノードの負荷を緩和するために効果的な方法です。<br>
また、元のOSDにある既存のデータは自動的にバランスされ、新旧のOSDが負荷を分担するようになります。</p>
</div>
<div class="paragraph">
<p><span class="keyseq"><kbd>Ctrl</kbd>+<kbd>D</kbd></span> を押すか、<code>exit</code> を実行して toolbox から出ることができます.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">exit</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="06-mcg.html">Multi-Cloud Gateway</a></span>
  <span class="next"><a href="08-monitoring.html">ODFのモニタリング</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
