<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Appendix: Cephの概要 :: ODF Workshop</title>
    <link rel="canonical" href="https://tutsunom.github.io/odf-workshop/odf-workshop/appendix-ceph.html">
    <link rel="prev" href="09-mustgather.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://tutsunom.github.io/odf-workshop">ODF Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="odf-workshop" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">ODF Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#01-setup.adoc">Setup</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-rbd_rwopvc.html">Ceph RBD volumeを使用するOCPアプリケーション</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-cephfs_rwxpvc.html">CephFS volumeを使用するOCPアプリケーション</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-clone_snapshot.html">PVCのクローンとスナップショット</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05-openshift_monitoring.html">OpenShift MonitoringでのODFの使用</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-mcg.html">Multi-Cloud Gateway</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="07-expand.html">ODFクラスタの拡張</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="08-monitoring.html">ODFのモニタリング</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="09-mustgather.html">must-gatherの使用</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="appendix-ceph.html">Appendix: Cephの概要</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">ODF Workshop</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">ODF Workshop</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">ODF Workshop</a></li>
    <li><a href="appendix-ceph.html">Appendix: Cephの概要</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/tutsunom/odf-workshop/edit/master/documentation/modules/ROOT/pages/appendix-ceph.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Appendix: Cephの概要</h1>
<div class="paragraph">
<p>このセクションでは、ODFで使用されるストレージソリューションの理解を深めるために、Cephの基礎知識を説明します。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
この付録の内容は、Cephの重要なコンポーネントとCephの動作について学習することを目的としています。
ODFではOpenShiftアプリケーションにストレージを提供するために、 <strong>Operators</strong> と <strong>CustomResourceDefinitions(CRDs)</strong> を使用した方法でCephをデプロイおよび管理します。
これにより一般的なスタンドアロンのCephと比べて、Cephの高度な機能の一部が制限されていることがあります。
</td>
</tr>
</table>
</div>
<div class="paragraph lead">
<p><strong>Cephの歴史</strong></p>
</div>
<div class="paragraph">
<p>Cephプロジェクトは以下のタイムラインでわかるように長い歴史があります。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/ceph101-timeline.png" alt="Ceph Project Timeline">
</div>
<div class="title">Figure 1. Ceph Project History</div>
</div>
<div class="paragraph lead">
<p>Cephは、OpenStackとKubernetesのストレージバックエンドとしてかなり長い間使用されてきた、歴戦のSoftware-defined Storage(SDS)ソリューションです。</p>
</div>
<div class="paragraph lead">
<p><strong>Architecture</strong></p>
</div>
<div class="paragraph">
<p>Cephクラスタは、スケーラブルなストレージソリューションを提供すると同時に、ITインフラストラクチャ内に存在するさまざまなタイプのクライアントがデータにアクセスできるように、複数のアクセス方法を提供します。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/ceph101-overview.png" alt="Ceph From Above">
</div>
<div class="title">Figure 2. Ceph Architecture</div>
</div>
<div class="paragraph lead">
<p>CephはResilientなアーキテクチャで、単一障害点(SPOF)がありません。</p>
</div>
<div class="paragraph lead">
<p><strong>RADOS</strong></p>
</div>
<div class="paragraph">
<p>Cephの中核は、アーキテクチャ図の最下層にあるRADOS(Reliable Autonomic Distributed Object Store)と呼ばれるオブジェクトストアです。<br>
RADOSによってCephはストレージとしてデータを保存する機能を提供します。
(つまり、IO要求を処理し、データを保護し、組み込みメカニズムによりデータの整合性と一貫性をチェックします)<br>
RADOSは次のデーモンで構成されます。</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>MONs or Monitors</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>OSDs or Object Storage Devices</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>MGRs or Managers</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>MDSs or Meta Data Servers</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title"><strong><em>MONs</em></strong></div>
<p>MONはCephのクラスタマップと状態を維持し、クラスタのサイズとトポロジーに応じて3または5といった奇数台で構成されます。
MONは複数台で分散意思決定を提供することでスプリットブレインの状況を防ぎます。<br>
またMONはDataPathになく、クライアントとの間でIO要求を処理しません。</p>
</div>
<div class="paragraph">
<div class="title"><strong><em>OSDs</em></strong></div>
<p>OSDは、データの保護(replication または erasure coding)、OSDまたはノード障害時のデータのリバランス、
データの一貫性(既存のデータのscrubbingおよびdeep-scrubbing)を保証しながら、クライアントからのIO要求を処理しています。<br>
通常、1つのブロックデバイスごとに1つのOSDが展開され、Cephのスケーラブルな性質により、数千のOSDをクラスタに含めることができます。</p>
</div>
<div class="paragraph">
<div class="title"><strong><em>MGRs</em></strong></div>
<p>MGRはMONと緊密に統合されており、クラスタ内の統計を収集します。<br>
さらに、Cephの機能拡張を目的としたpluggableなPythonインターフェイスを介して、拡張可能なフレームワークを提供します。
Managerフレームワークを中心に開発されたモジュールの現在のリストは次のとおりです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Balancer module</p>
</li>
<li>
<p>Placement Group auto-scaler module</p>
</li>
<li>
<p>Dashboard module</p>
</li>
<li>
<p>RESTful module</p>
</li>
<li>
<p>Prometheus module</p>
</li>
<li>
<p>Zabbix module</p>
</li>
<li>
<p>Rook module</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title"><strong><em>MDSs</em></strong></div>
<p>MDSはディレクトリ階層やファイルのメタデータ(ownership, timestamp、modeなど)など、POSIX準拠の共有ファイルシステムのメタデータを管理します。
すべてのメタデータはRADOSで保存され、クライアントでメタデータを管理することはありません。<br>
MDSは、CephFSによる共有ファイルシステムが構成されている場合にのみデプロイされます。</p>
</div>
<div class="paragraph">
<p>Cephクラスタの基盤の全体像はさまざまな種類のデーモンまたはコンテナによって構成されています。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/ceph101-rados.png" alt="RADOS Overview">
</div>
<div class="title">Figure 3. RADOS as it stands</div>
</div>
<div class="paragraph">
<p>上の図では、円はMONを表し、「M」はMGRを表し、バーのある四角はOSDを表します。
上の図ではクラスタは3つのMON、2つのMGR、23のOSDで動作しています。</p>
</div>
<div class="paragraph lead">
<p><strong>アクセス方式</strong></p>
</div>
<div class="paragraph">
<p>Cephは、すべてのアプリケーションがそのユースケースに最適なストレージを使用できるように、すべてのアクセス方法を提供するように設計されています。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/ceph101-differentstoragetypes.png" alt="Ceph Access Modes">
</div>
<div class="title">Figure 4. Different Storage Types Supported</div>
</div>
<div class="paragraph">
<p>Cephは、</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RADOS Block Device(RBD)アクセス方式によるブロックストレージ</p>
</li>
<li>
<p>Ceph Filesystem(CephFS)アクセス方式によるファイルストレージ</p>
</li>
<li>
<p>ネイティブの <code>librados</code> API、またはRADOS Gateway(RADOSGWまたはRGW)によるS3/Swiftプロトコルを使用するオブジェクトストレージ</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>をサポートします。</p>
</div>
<div class="paragraph lead">
<p><strong>Librados</strong></p>
</div>
<div class="paragraph">
<p>Libradosを使用すると、アプリケーション開発者はのCephクラスタがネイティブに持つAPIでコーディングできます。<br>
この結果、小さなフットプリントで大きな効率を得ることができます。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/ceph101-librados.png" alt="librados">
</div>
<div class="title">Figure 5. Application Native Object API</div>
</div>
<div class="paragraph">
<p>CephのネイティブAPIは、C, C++, Python, Java, Ruby, Erlang, Go, Rustなどのさまざまなラッパーを提供しています。</p>
</div>
<div class="paragraph lead">
<p><strong>RADOS Block Device (RBD)</strong></p>
</div>
<div class="paragraph">
<p>このアクセス方法は、Red Hat Enterprise LinuxまたはOpenShiftバージョン3.xまたは4.xで使用されます。
RBDは、カーネルモジュール(RHEL、OCP4) または <code>librbd</code> API(RHOSP)からアクセスできます。
OCPの世界では、RBDはRWO PVCの必要性に対処するように設計されています。</p>
</div>
<div class="paragraph lead">
<p><strong><em>Kernel Module (kRBD)</em></strong></p>
</div>
<div class="paragraph">
<p>kRBDドライバーは、ユーザースペースの <code>librbd</code> 方式と比較して優れたパフォーマンスを提供します。
ただし、kRBDは現在制限されており <code>librbd</code> と同じレベルの機能を提供していません。例えば、RBDミラーリングはサポートされていません。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/ceph101-krbd.png" alt="Kernel based RADOS Block Device">
</div>
<div class="title">Figure 6. kRBD Diagram</div>
</div>
<div class="paragraph lead">
<p><strong><em>Userspace RBD (librbd)</em></strong></p>
</div>
<div class="paragraph">
<p>このアクセス方法は、RHEL 8.1 KernelからRed Hat OpenStackまたはOpenShiftでRBD-NBDドライバーを介して使用されます。<br>
このモードにより、RBDミラーリングなどの既存のRBD機能をすべて活用できます。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/ceph101-librbd.png" alt="Userspace RADOS Block Device">
</div>
<div class="title">Figure 7. librbd Diagram</div>
</div>
<div class="paragraph lead">
<p><strong><em>共有ファイルシステム (CephFS)</em></strong></p>
</div>
<div class="paragraph">
<p>この方法により、クライアントはPOSIX互換の共有ファイルシステムに同時にアクセスできます。<br>
クライアントは最初にメタデータサーバーに接続して、特定のi-nodeのオブジェクトの場所を取得し、最終的にOSDと直接通信してIO要求を実行します。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/ceph101-cephfs.png" alt="Kernel Based CephFS Client">
</div>
<div class="title">Figure 8. File Access (Ceph Filesystem or CephFS)</div>
</div>
<div class="paragraph">
<p>CephFSは通常はRWXのPVCに使用されますが、RWO PVCもサポートします。</p>
</div>
<div class="paragraph lead">
<p><strong><em>S3/Swiftオブジェクトストレージ (Ceph RADOS Gateway)</em></strong></p>
</div>
<div class="paragraph">
<p>このアクセス方法は、Cephクラスタ上でAmazon S3およびOpenStack Swift互換のオブジェクトアクセスをサポートします。<br>
ODF MCGでは、RADOSGWを活用してObject Bucket Claimを処理することも可能です。この場合は、MCGからは、RADOSGWはS3互換性のあるS3 endpointとしてタグ付けされます。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/ceph101-rgw.png" alt="S3 and Swift Support">
</div>
<div class="title">Figure 9. Amazone S3 or OpenStack Swift (Ceph RADOS Gateway)</div>
</div>
<div class="paragraph lead">
<p><strong>CRUSH</strong></p>
</div>
<div class="paragraph">
<p>分散アーキテクチャであるCephクラスタは、クラスタ内の複数のOSDにデータを効率的に分散するように設計されています。<br>
そのためにCRUSH(Controlled Replication Under Scalable Hashing)と呼ばれる手法が使われます。<br>
CRUSHでは、すべてのオブジェクトはPlacement Group(PG)と呼ばれる、1つのユニークなハッシュバケットに割り当てられます。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/ceph101-crushfromobjecttoosd.png" alt="From Object to OSD">
</div>
</div>
<div class="paragraph">
<p>CRUSHはCephクラスタのトポロジー構成の中心です。<br>
擬似ランダム配置アルゴリズムによってRADOS内のオブジェクトを分散し、CRUSHルールを使用してPGとOSDのマッピングを決定します。本質的にPGはオブジェクト(アプリケーション層)とOSD(物理層)の間の抽象化層と言えます。<br>
障害が発生した場合、PGは異なるOSDに再マップされ、最終的にストレージ管理者が選択したルールに一致するようにデータが再同期されます。</p>
</div>
<div class="paragraph lead">
<p><strong>クラスタのパーティショニング</strong></p>
</div>
<div class="paragraph">
<p>クラスタはPoolと呼ばれる論理的なパーティションで分割されます。各プールには次のプロパティがあります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pool ID (変更不可)</p>
</li>
<li>
<p>名前</p>
</li>
<li>
<p>PGの数</p>
</li>
<li>
<p>PGとOSDのマッピングを決定するCRUSHルール</p>
</li>
<li>
<p>データ保護のタイプ(Replication or Erasure Coding)</p>
</li>
<li>
<p>データ保護のタイプに関連するパラメータ</p>
<div class="ulist">
<ul>
<li>
<p>Rreplicated poolにおけるレプリカの数</p>
</li>
<li>
<p>Erasure Coded poolにおけるチャンク数(K+M)</p>
</li>
</ul>
</div>
</li>
<li>
<p>クラスタの動作に影響を与えるさまざまなフラ</p>
</li>
</ul>
</div>
<div class="paragraph lead">
<p><strong>PoolとPG</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/ceph101-thefullpicture.png" alt="From Object to OSD">
</div>
<div class="title">Figure 10. Pools and PGs</div>
</div>
<div class="paragraph">
<p>上の図は、クライアントIOにより保存されるオブジェクトから物理層のOSDまでの、End-to-Endの関係を示しています。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Poolにはサイズがなく、PGが作成されたOSDで使用可能なスペースを消費できます。また1つのPGは1つのプールのみに属します。
</td>
</tr>
</table>
</div>
<div class="paragraph lead">
<p><strong>データ保護</strong></p>
</div>
<div class="paragraph">
<p>Cephは、次の図に示す2つのタイプのデータ保護をサポートしています。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/ceph101-dataprotection.png" alt="Replicated Pools vs Erasure Coded Pools">
</div>
<div class="title">Figure 11. Ceph Data Protection</div>
</div>
<div class="paragraph">
<p>Replicated poolは、オブジェクトを複製するため容量効率が低い(物理3バイトに対して実効は1バイト)一方で、ほとんどの場合においてErasure Coded poolよりも良好なパフォーマンスを示します。</p>
</div>
<div class="paragraph">
<p>Erasure Coded poolは、パフォーマンスはReplicated poolに劣る一方で、高い容量効率を示します。
Erasure Coded poolは使用するパリティの数を構成できるため、高いResiliencyと耐久性を提供できることです。
Erasure Coded poolでは次のようなK+Mの比率をサポートします。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>4+2 (実効容量:物理容量 = 2:3)</p>
</li>
<li>
<p>8+3 (実効容量:物理容量 = 8:11)</p>
</li>
<li>
<p>8+4 (実効容量:物理容量 = 2:3)</p>
</li>
</ul>
</div>
<div class="paragraph lead">
<p><strong>データの分散</strong></p>
</div>
<div class="paragraph">
<p>Cephアーキテクチャを最大限に活用するために、libradosを除くすべてのアクセス方法でオブジェクに分割して保存されます。<br>
1GBのRBDイメージは複数のオブジェクトに分割されてRADOSに保存されます。CephFSやRADOSGWも同様です。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/ceph101-rbdlayout.png" alt="RADOS Block Device Layout">
</div>
<div class="title">Figure 12. Data Distribution</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
デフォルトでは、各アクセス方法は4MBのオブジェクトサイズを使用します。
上の図はRWO PVCをサポートする32MB RBDがCephクラスター全体にどのように分散して保存されるかを示しています。
</td>
</tr>
</table>
</div>
<nav class="pagination">
  <span class="prev"><a href="09-mustgather.html">must-gatherの使用</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
