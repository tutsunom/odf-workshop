<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OpenShift MonitoringでのODFの使用 :: ODF Workshop</title>
    <link rel="canonical" href="https://tutsunom.github.io/odf-workshop/odf-workshop/05-openshift_monitoring.html">
    <link rel="prev" href="04-clone_snapshot.html">
    <link rel="next" href="06-mcg.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://tutsunom.github.io/odf-workshop">ODF Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="odf-workshop" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">ODF Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#01-setup.adoc">Setup</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-rbd_rwopvc.html">Ceph RBD volumeを使用するOCPアプリケーション</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-cephfs_rwxpvc.html">CephFS volumeを使用するOCPアプリケーション</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-clone_snapshot.html">PVCのクローンとスナップショット</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="05-openshift_monitoring.html">OpenShift MonitoringでのODFの使用</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-mcg.html">Multi-Cloud Gateway</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="07-expand.html">ODFクラスタの拡張</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="08-monitoring.html">ODFのモニタリング</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="09-mustgather.html">must-gatherの使用</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="appendix-ceph.html">Appendix: Cephの概要</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">ODF Workshop</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">ODF Workshop</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">ODF Workshop</a></li>
    <li><a href="05-openshift_monitoring.html">OpenShift MonitoringでのODFの使用</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/tutsunom/odf-workshop/edit/master/documentation/modules/ROOT/pages/05-openshift_monitoring.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">OpenShift MonitoringでのODFの使用</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>OpenShiftには、オープンソースプロジェクトであるPrometheusと、その広範なエコシステムをベースとした、モニタリングスタックが同梱されています。このモニタリングスタックは事前設定されており、さらにユーザ自身が設定できるようになっています。また、クラスタコンポーネントをモニタリングし、発生した問題をクラスタ管理者に直ちに通知するためのアラートセットが含まれています。<br>
本番環境においては、モニタリングスタックをブロックストレージベースの永続ストレージを使って構成することが強く推奨されます。永続ストレージを使用することで、メトリクスデータやアラートデータが永続ボリュームに保存され、Podの再起動や再作成に耐えられるようになるためです。<br>
ODFでは、Ceph RBD volumeによってブロックストレージを提供します。このセクションでは、PrometheusとAlertManagerのストレージとしてODF Ceph RBD volumeを使って永続化する方法について詳しく説明します。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_openshift_monitoringのデフォルトストレージ"><a class="anchor" href="#_openshift_monitoringのデフォルトストレージ"></a>OpenShift Monitoringのデフォルトストレージ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>まず、<code>openshift-monitoring</code> Namespaceで作成されているPodと <strong>PVC</strong> を見つけましょう。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -n openshift-monitoring</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                               READY   STATUS    RESTARTS      AGE
pod/alertmanager-main-0                            5/5     Running   0             2m6s
pod/alertmanager-main-1                            5/5     Running   0             2m14s
pod/alertmanager-main-2                            5/5     Running   0             2m24s
pod/cluster-monitoring-operator-64fcf6fdd9-rrzq5   2/2     Running   0             30h
pod/grafana-7fdc7d846d-lnr98                       2/2     Running   0             2m25s
pod/kube-state-metrics-c4fd7d5d5-jq9vq             3/3     Running   0             2m27s
pod/node-exporter-5k7bd                            2/2     Running   0             29h
pod/node-exporter-7stxr                            2/2     Running   0             29h
pod/node-exporter-ck2n4                            2/2     Running   0             29h
pod/node-exporter-dp7kl                            2/2     Running   0             10m
pod/node-exporter-f29xl                            2/2     Running   0             30h
pod/node-exporter-fs299                            2/2     Running   0             29h
pod/node-exporter-gch4v                            2/2     Running   0             29h
pod/node-exporter-nv5sq                            2/2     Running   0             29h
pod/node-exporter-ppn72                            2/2     Running   0             10m
pod/node-exporter-qnqz8                            2/2     Running   0             30h
pod/node-exporter-rw7d2                            2/2     Running   0             10m
pod/node-exporter-x5crx                            2/2     Running   0             30h
pod/node-exporter-zv6l7                            2/2     Running   0             29h
pod/openshift-state-metrics-7f848466cf-lcvdh       3/3     Running   0             30h
pod/prometheus-adapter-56fdd7694d-d67mn            1/1     Running   0             2m26s
pod/prometheus-adapter-56fdd7694d-tfwk7            1/1     Running   0             2m27s
pod/prometheus-k8s-0                               7/7     Running   0             2m7s
pod/prometheus-k8s-1                               7/7     Running   0             2m20s
pod/prometheus-operator-7c888bcd97-gpx58           2/2     Running   0             2m33s
pod/telemeter-client-69bd5b755f-6pxv2              3/3     Running   0             2m27s
pod/thanos-querier-6b55bc48bb-ft8q2                5/5     Running   0             29h
pod/thanos-querier-6b55bc48bb-zhvlx                5/5     Running   0             29h</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pvc -n openshift-monitoring</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">No resources found in openshift-monitoring namespace.</code></pre>
</div>
</div>
<div class="paragraph">
<p>この時点では <strong>PVC</strong> は存在しません。これはモニタリングスタック内の Prometheus も AlertManager もエフェメラルなストレージ(EmptyDir)を使用しているためです。OpenShift がインストールされた直後はこの方法がとられます。<br>
Prometheus は、Prometheus データベースと AlertManager のデータで構成されています。どちらかのデータが失われるとメトリクスやアラートのデータが失われるため、両方を永続化することがベストプラクティスです。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prometheus環境の変更"><a class="anchor" href="#_prometheus環境の変更"></a>Prometheus環境の変更</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Prometheus では、サポートされる全ての設定変更は中央の <strong>ConfigMap</strong> を通じて制御されます。したがって、この <strong>ConfigMap</strong> は変更を加える前に存在する必要があります。<br>
Openshift のインストール直後は、Prometheus の環境を設定するための <strong>ConfigMap</strong> が存在しない場合があります。<strong>ConfigMap</strong> が存在するかどうかを確認するには、以下のように実行します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n openshift-monitoring get configmap cluster-monitoring-config</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">ConfigMapが作成されていない場合の出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Error from server (NotFound): configmaps "cluster-monitoring-config" not found</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">ConfigMapが作成されている場合の出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                        DATA   AGE
cluster-monitoring-config   1      10m</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>ConfigMap</strong> がない場合は、このコマンドで作成してください。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f {{ HOME_PATH }}/support/ocslab_cluster-monitoring-noinfra.yaml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">configmap/cluster-monitoring-config created</code></pre>
</div>
</div>
<div class="paragraph">
<p>もし <strong>ConfigMap</strong> が既にあるならば、次のコマンドを実行して、既存の <strong>ConfigMap</strong> に変更を適用してください。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f {{ HOME_PATH }}/support/ocslab_cluster-monitoring-withinfra.yaml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">configmap/cluster-monitoring-config updated</code></pre>
</div>
</div>
<div class="paragraph">
<p>作成された <strong>ConfigMap</strong> は次のコマンドで見ることができます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Ceph RBD volumeのサイズである <code>40Gi</code> は、要件に応じて大きくしたり小さくしたりすることができます。
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n openshift-monitoring get configmap cluster-monitoring-config -o yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ConfigMap 出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">[...]
    prometheusK8s:
      volumeClaimTemplate:
        metadata:
          name: alertmanager
        spec:
          storageClassName: ocs-storagecluster-ceph-rbd
          resources:
            requests:
              storage: 40Gi
[...]
    alertmanagerMain:
      volumeClaimTemplate:
        metadata:
          name: prometheusdb
        spec:
          storageClassName: ocs-storagecluster-ceph-rbd
          resources:
            requests:
              storage: 40Gi
[...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>この新しい <code>cluster-monitoring-config</code> <strong>ConfigMap</strong> を作成すると、影響を受けるPodが自動的に再起動され、新しい永続ボリュームがマウントされます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
デフォルトのEmptyDirのストレージに書き込まれたデータを、新しい永続ボリュームに引き継ぐことはできません。したがって、バックエンドのストレージを変更した後は、空の状態のデータベースからメトリクスの収集とレポーティングを始めることになります。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>数分後には、AlertManagerとPrometheusのPodが再起動します。<code>openshift-monitoring</code> Namespace に新しい <strong>PVC</strong> が表示され、それらが永続ストレージを提供するようになったことが確認できます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pvc -n openshift-monitoring</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                               STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS                  AGE
alertmanager-alertmanager-main-0   Bound    pvc-592e4313-c435-4120-bfc5-0efa9fdafbf3   40Gi       RWO            ocs-storagecluster-ceph-rbd   3m37s
alertmanager-alertmanager-main-1   Bound    pvc-43d31e4d-8ceb-442a-93c1-07f7fa17f5e9   40Gi       RWO            ocs-storagecluster-ceph-rbd   3m37s
alertmanager-alertmanager-main-2   Bound    pvc-4139266e-7621-4eee-b14d-a69bee7e22c8   40Gi       RWO            ocs-storagecluster-ceph-rbd   3m37s
prometheusdb-prometheus-k8s-0      Bound    pvc-1d470a18-ed7b-48f2-93d2-303448572376   40Gi       RWO            ocs-storagecluster-ceph-rbd   3m31s
prometheusdb-prometheus-k8s-1      Bound    pvc-fff015f0-be83-4d68-bd42-7d3250cf1d9f   40Gi       RWO            ocs-storagecluster-ceph-rbd   3m31s</code></pre>
</div>
</div>
<div class="paragraph">
<p>永続ストレージを変更した後もPrometheusとAlertManagerが正しく動作しているかは、後の<a href="#ODF環境のモニタリング">[ODF環境のモニタリング]</a>セクションで確認できます。</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="04-clone_snapshot.html">PVCのクローンとスナップショット</a></span>
  <span class="next"><a href="06-mcg.html">Multi-Cloud Gateway</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
