<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ODF Operatorを使用したストレージのデプロイ :: ODF Workshop</title>
    <link rel="canonical" href="https://tutsunom.github.io/odf-workshop/odf-workshop/01-odf_deploy.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://tutsunom.github.io/odf-workshop">ODF Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="odf-workshop" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">ODF Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#01-setup.adoc">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#01-setup.adoc#prerequisite">Prerequisites</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#02-getting_started.adoc">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#02-getting_started.adoc#install_acs_operator">Install RHACS Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#02-getting_started.adoc#install_acs_central">Install RHACS Central Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#02-getting_started.adoc#config_acs_securedcluster">Configuration of the RHACS Secured Cluster </a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#02-getting_started.adoc#deploy_demo_acs">Deploying Demo in RHACS</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#02-getting_started.adoc#deploy_apps">Deploying Apps</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-overview-acs.html">RHACS Overview</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-overview-acs.html#acs_architecture">RHACS Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-overview-acs.html#dashboard_acs">RHACS Dashboard</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-overview-acs.html#dashboard_acs_header">Dashboard Header</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-overview-acs.html#dashboard_acs_menu">Dashboard Left Menu</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-overview-acs.html#dashboard_acs_information">Dashboard Information</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-vulnerabilities.html">Vulnerability Management</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-vulnerabilities.html#image_overview_image_details">Image overview and image details</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-vulnerabilities.html#vulnerability_management_panel">Review Vulnerability Management Dashboard</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-vulnerabilities.html#scanning_images">Scanning images for vulnerabilities</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-vulnerabilities.html#filtering_vulnerabilities_scans">Filtering vulnerabilities scans</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-vulnerabilities.html#review_cve_images">Image CVE Vulnerability Analysis</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-vulnerabilities.html#image_correlation_deployments">Image CVE correlation with Deployments</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-risk.html">Risk Management</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-risk.html#risk_dashboard">Review Risk Dashboard</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-risk.html#risk_single_deployment_details">Single Deployment Details</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-risk.html#risk_process_discovery">Process Discovery / Runtime</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-risk.html#risk_filtering">Filtering</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-network_graph.html">Network Graph</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-network_graph.html#network_graph_overview">Network Graph Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-network_graph.html#network_graph_views">Network Graph Views</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-network_graph.html#network_policy_simulator">Network Policy Simulator</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-violations.html">Violations</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-violations.html#violations_overview">Violations Dashboard Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-violations.html#violations_example">Violations Build &amp; Deploy Example</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-violations.html#violations_runtime">Violations Runtime Example</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-violations.html#violations_behaviour">Violations Behaviour</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-violations.html#policy_summary">Policy Summary</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-compliance.html">Compliance</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-compliance.html#compliance_dashboard">Review Compliance Dashboard</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-compliance.html#compliance_dashboard_scan">Execute the first Compliance Scan</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-compliance.html#compliance_dashboard_review">Review the Compliance Reports in the Compliance Dashboard</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-compliance.html#compliance_dashboard_ns">Namespace Compliance Details</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-compliance.html#compliance_dashboard_report">Evidence Export</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-compliance.html#compliance_operator">Integrating Compliance Operator with RHACS </a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-compliance.html#compliance_operator_acs_review">Review Compliance Scans of the Compliance Operator in RHACS</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-compliance.html#acs_policy_compliance">Configure Policy in RHACS to Invoke Compliance related Controls</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-compliance.html#acs_policy_compliance_nist">Enforce Policies that Meet Guidance for NIST Control 4.2.2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-compliance.html#acs_policy_compliance_nist_view">View Updated Compliance Scan Results in RHACS</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-compliance.html#acs_policy_compliance_nist_revert">Revert the Policy Changes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="09-configuration_management.html">Configuration Management</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-configuration_management.html#conf_management_overview">Configuration Management Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-configuration_management.html#conf_management_cis">Configuration Management CIS</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="10-system_policies.html">System Policies</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-system_policies.html#system_policies_overview">System Policies Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-system_policies.html#system_policies_example">System Policies Build and Deploy Example</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-system_policies.html#system_policies_enforcement">System Policies Enforcement</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="11-integrations.html">RHACS Integrations</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="11-integrations.html#integrate_with_internal_openshift_registry">Integrate with Internal Openshift Registry</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="11-integrations.html#integrate_with_internal_openshift_registry_config_acs">Configure RHACS integration for Internal Openshift Registry</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="11-integrations.html#integrate_acs_slack">Integrate RHACS with Slack</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="11-integrations.html#integrate_acs_oauth">Integrate RHACS with OpenShift OAuth</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="11-integrations.html#integrate_acs_sso">Integrate RHACS with OpenShift RHSSO</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="12-platform_configuration.html">RHACS Secure Cluster Management</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="12-platform_configuration.html#system_configuration">RHACS System Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="12-platform_configuration.html#system_health">RHACS System Health</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="12-platform_configuration.html#access_control">RHACS Access Control</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="14-cicd-jp.html">RHACSを使用したアプリケーションへの自動化セキュリティの実装とDevSecOpsの構築</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="14-cicd-jp.html#setup">セットアップ</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="14-cicd-jp.html#ci">継続的インテグレーション</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="14-cicd-jp.html#devsecops">ACSを利用したDevSecOpsのステップ</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="14-cicd-jp.html#cd">GitOpsを使った継続的デリバリー</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="14-cicd-jp.html#dast">PostCI - ダイナミックアプリケーションセキュリティとテスト (DAST)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="14-cicd-jp.html#policy_violation">セキュリティポリシーとCI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="14-cicd-jp.html#fiximage">ボーナスラボ</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="14-cicd-jp.html#troubleshooting">トラブルシューティング</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="15-contributors.html">Contributors</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">ODF Workshop</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">ODF Workshop</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">ODF Workshop</a></li>
    <li><a href="01-odf_deploy.html">ODF Operatorを使用したストレージのデプロイ</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/tutsunom/odf-workshop/edit/master/documentation/modules/ROOT/pages/01-odf_deploy.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">ODF Operatorを使用したストレージのデプロイ</h1>
<div class="sect1">
<h2 id="_gitリポジトリのクローン"><a class="anchor" href="#_gitリポジトリのクローン"></a>Gitリポジトリのクローン</h2>
<div class="sectionbody">
<div class="paragraph">
<p>まずGitリポジトリをクローンし、ディレクトリに移動します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git clone <a href="https://github.com/tutsunom/odf-workshop.git" class="bare">https://github.com/tutsunom/odf-workshop.git</a></code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd odf-workshop</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ocpクラスタのスケールと新しいworkerノードの追加"><a class="anchor" href="#_ocpクラスタのスケールと新しいworkerノードの追加"></a>OCPクラスタのスケールと新しいWorkerノードの追加</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このセクションでは、ODFリソースのために3つのWorkerノードを追加してOCPクラスタをスケールする前に、まずOCP環境のWorkerノードを確認します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get nodes -l node-role.kubernetes.io/worker -l '!node-role.kubernetes.io/infra','!node-role.kubernetes.io/master'</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                         STATUS   ROLES    AGE   VERSION
ip-10-0-129-208.us-east-2.compute.internal   Ready    worker   15m   v1.22.8+c02bd9d
ip-10-0-157-116.us-east-2.compute.internal   Ready    worker   15m   v1.22.8+c02bd9d
ip-10-0-185-31.us-east-2.compute.internal    Ready    worker   15m   v1.22.8+c02bd9d
ip-10-0-215-4.us-east-2.compute.internal     Ready    worker   15m   v1.22.8+c02bd9d</code></pre>
</div>
</div>
<div class="paragraph">
<p>ここで <strong>MachineSets</strong> を使用して、さらに3つのWorkerノードをクラスタに追加することになります。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get machinesets -n openshift-machine-api | grep -v infra</code></pre>
</div>
</div>
<div class="paragraph">
<p>ここでは、既にクラスタに存在するWorkerノードを作成するために使用される、既存の <strong>MachineSets</strong> が表示されます。3つのAWS Availability Zone (AZ)それぞれに <strong>MachineSet</strong> が存在することが分かります。</p>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                    DESIRED   CURRENT   READY   AVAILABLE   AGE
cluster-d6qlm-mbttv-worker-us-east-2a   2         2         2       2           27m
cluster-d6qlm-mbttv-worker-us-east-2b   1         1         1       1           27m
cluster-d6qlm-mbttv-worker-us-east-2c   1         1         1       1           27m</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
既存の <strong>MachineSet</strong> が3つのAZに無いOCPクラスタでもそのまま継続できます。後ほど対応します。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>新しい <strong>MachineSets</strong> を作成して、各AWS AZにOCP クラスタのストレージ専用ノードを作成します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">chmod +x labitem/machineset-cli
bash labitem/machineset-generator.sh 3 workerocs 0 | oc create -f -
oc get machineset -n openshift-machine-api -l machine.openshift.io/cluster-api-machine-role=workerocs -o name | xargs oc patch -n openshift-machine-api --type='json' -p '[{"op": "add", "path": "/spec/template/spec/metadata/labels", "value":{"node-role.kubernetes.io/worker":"", "role":"storage-node", "cluster.ocs.openshift.io/openshift-storage":""} }]'
oc get machineset -n openshift-machine-api -l machine.openshift.io/cluster-api-machine-role=workerocs -o name | xargs oc scale -n openshift-machine-api --replicas=1</code></pre>
</div>
</div>
<div class="paragraph">
<p>新しい <strong>Machines</strong> が作成されていることを確認します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get machines -n openshift-machine-api | egrep 'NAME|workerocs'</code></pre>
</div>
</div>
<div class="paragraph">
<p>しばらくは <code>Provisioning</code> または <code>Provisioned</code> の状態にありますが、最終的には <code>Running</code> の状態になります。</p>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                             PHASE     TYPE         REGION      ZONE         AGE
cluster-d6qlm-mbttv-workerocs-us-east-2a-v8p5k   Running   m5.4xlarge   us-east-2   us-east-2a   4m39s
cluster-d6qlm-mbttv-workerocs-us-east-2b-dx69b   Running   m5.4xlarge   us-east-2   us-east-2b   4m38s
cluster-d6qlm-mbttv-workerocs-us-east-2c-g7hlh   Running   m5.4xlarge   us-east-2   us-east-2c   4m38s</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>既存の <strong>MachineSet</strong> が3つのAZに無いOCPクラスタでは、<code>Failed</code> 状態の <strong>Machine</strong> が存在します。この場合は、<code>Failed</code> 状態の <strong>Machine</strong> に対応する <strong>MachineSet</strong> を削除して下さい。<br>
代わりに、<code>Provisioning</code> または <code>Provisioned</code> の状態の <strong>Machine</strong> に対応する <strong>MachineSet</strong> を適宜 Scale-Out して、最終的に3台のworkerocs <strong>Machine</strong> を持つように設定して下さい。</p>
</div>
<div class="listingblock console-output">
<div class="title"><code>us-east-2c</code> AZにのみ既存 <strong>MachineSet</strong> がある場合の例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get machines -n openshift-machine-api | egrep 'NAME|workerocs'
NAME                                             PHASE     TYPE         REGION      ZONE         AGE
cluster-2mwq7-jls22-workerocs-us-east-2c-ch9ds   Running   m5.4xlarge   us-east-2   us-east-2c   18m
cluster-2mwq7-jls22-workerocs-us-east-2c-r5smx   Running   m5.4xlarge   us-east-2   us-east-2c   19m
cluster-2mwq7-jls22-workerocs-us-east-2c-scjvh   Running   m5.4xlarge   us-east-2   us-east-2c   18m

$ oc get machineset -n openshift-machine-api | egrep 'NAME|workerocs'
NAME                                       DESIRED   CURRENT   READY   AVAILABLE   AGE
cluster-2mwq7-jls22-workerocs-us-east-2c   3         3         3       3           30m</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>workerocs <strong>Machines</strong> はAWS EC2の <code>m5.4xlarge</code> インスタンスタイプを使用していることがわかります。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>m5.4xlarge</code> インスタンスタイプは、16vCPUと64GBのメモリを持ち、ODFで推奨されるスペックです。<br>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>さて、私たちの新しい <strong>Machines</strong> がOCPクラスタに追加されているかどうかを確認します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch "oc get machinesets -n openshift-machine-api | egrep 'NAME|workerocs'"</code></pre>
</div>
</div>
<div class="paragraph">
<p>新しい workerocs <strong>MachineSet</strong> の全てで <code>READY</code> と <code>AVAILABLE</code> のカラムに数値(この場合は <code>1</code> )が表示されるまで待ちます。このステップには5分以上かかる場合があります。</p>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                       DESIRED   CURRENT   READY   AVAILABLE   AGE
cluster-d6qlm-mbttv-workerocs-us-east-2a   1         1         1       1           5m25s
cluster-d6qlm-mbttv-workerocs-us-east-2b   1         1         1       1           5m25s
cluster-d6qlm-mbttv-workerocs-us-east-2c   1         1         1       1           5m25s</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span>を押すと終了できます。</p>
</div>
<div class="paragraph">
<p>最後に、3つのWorkerノードが追加されていることを確認します。全てのworker nodeの <code>STATUS</code> が <code>Ready</code> であることを確認します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get nodes -l node-role.kubernetes.io/worker -l '!node-role.kubernetes.io/infra','!node-role.kubernetes.io/master'</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                         STATUS   ROLES    AGE   VERSION
ip-10-0-129-208.us-east-2.compute.internal   Ready    worker   45m   v1.22.8+c02bd9d
ip-10-0-142-148.us-east-2.compute.internal   Ready    worker   13m   v1.22.8+c02bd9d
ip-10-0-157-116.us-east-2.compute.internal   Ready    worker   45m   v1.22.8+c02bd9d
ip-10-0-173-143.us-east-2.compute.internal   Ready    worker   13m   v1.22.8+c02bd9d
ip-10-0-185-31.us-east-2.compute.internal    Ready    worker   45m   v1.22.8+c02bd9d
ip-10-0-215-4.us-east-2.compute.internal     Ready    worker   45m   v1.22.8+c02bd9d
ip-10-0-219-73.us-east-2.compute.internal    Ready    worker   13m   v1.22.8+c02bd9d</code></pre>
</div>
</div>
<div class="paragraph">
<p>新しいOCP WorkerノードがODF用のラベルを持っていることを確認します。<br>
ODFを稼働させるノードには、<code>cluster.ocs.openshift.io/openshift-storage</code> という特定のラベルが付いている必要があります。<br>
先に <code>workerocs</code> <strong>MachineSets</strong> を作成した時にこのラベルを追加しています。これらの <strong>MachineSets</strong> を使って作成されたすべての <strong>Machine</strong> はこのラベルを持つことになります。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get nodes -l cluster.ocs.openshift.io/openshift-storage=</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                         STATUS   ROLES    AGE   VERSION
ip-10-0-142-148.us-east-2.compute.internal   Ready    worker   14m   v1.22.8+c02bd9d
ip-10-0-173-143.us-east-2.compute.internal   Ready    worker   14m   v1.22.8+c02bd9d
ip-10-0-219-73.us-east-2.compute.internal    Ready    worker   14m   v1.22.8+c02bd9d</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_odf_operatorを使ったodfクラスタの作成"><a class="anchor" href="#_odf_operatorを使ったodfクラスタの作成"></a>ODF Operatorを使ったODFクラスタの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このセクションではOpenShift Data Foundation(ODF) Operatorをインストールし、新しく追加した3つのWorkerノードを使ってODFクラスタを作成します。<br>
以下がインストールされます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ODF <strong>OperatorGroup</strong></p>
</li>
<li>
<p>ODF <strong>Subscription</strong></p>
</li>
<li>
<p>他の全てのODF リソース (Operators, Ceph Pods, NooBaa Pods, StorageClasses)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>はじめに <code>openshift-storage</code> Namespace を作成します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create namespace openshift-storage</code></pre>
</div>
</div>
<div class="paragraph">
<p>このNamespaceには、モニタリング用のラベルを追加する必要があります。これは、OCPストレージダッシュボードの Prometheus メトリクスとアラートを取得するために必要です。<br>
<code>openshift-storage</code> Namespaceにラベルを付けるには、次のコマンドを使用します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc label namespace openshift-storage "openshift.io/cluster-monitoring=true"</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>openshift-storage</code> Namespaceの作成とモニタリング用のラベル付けは、<strong>OpenShift Web Console</strong> を使用してODF Operatorのインストール時に行うこともできます。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ログインしたら左側のメニューから、<strong>Operators</strong> &#8594; <strong>OperatorHub</strong> を選択します。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/OCS-OCP-OperatorHub.png" alt="OCP OperatorHub">
</div>
<div class="title">Figure 1. OCP OperatorHub</div>
</div>
<div class="paragraph">
<p>Now type <code>openshift data foundation</code> in the <strong>Filter by <em>keyword&#8230;&#8203;</em></strong> box.
<strong>Filter by <em>keyword&#8230;&#8203;</em></strong> のボックスに、<code>openshift data foundation</code> と入力します。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/OCS4-OCP-OperatorHub-Filter.png" alt="OCP OperatorHub Filter">
</div>
<div class="title">Figure 2. OCP OperatorHub filter on OpenShift Data Foundation Operator</div>
</div>
<div class="paragraph">
<p>表示された <code>OpenShift Data Foundation Operator</code> を選択し、 <strong>Install</strong> ボタンを押します。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/OCS4-OCP4-OperatorHub-Install.png" alt="OCP OperatorHub Install">
</div>
<div class="title">Figure 3. OCP OperatorHub Install OpenShift Data Foundation</div>
</div>
<div class="paragraph">
<p>次の画面で、<code>channel</code> や <code>Installed Namespace</code> などを設定しますが、<strong>デフォルトのまま Install をクリックします。</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/OCS4-OCP4-OperatorHub-Subscribe.png" alt="OCP OperatorHub Subscribe">
</div>
<div class="title">Figure 4. OCP Subscribe to OpenShift Data Foundation</div>
</div>
<div class="paragraph">
<p>ターミナルに戻って、下のコマンドを実行してインストール状況を確認できます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch oc -n openshift-storage get csv</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                  DISPLAY                       VERSION   REPLACES              PHASE
mcg-operator.v4.9.8   NooBaa Operator               4.9.8     mcg-operator.v4.9.7   Succeeded
ocs-operator.v4.9.8   OpenShift Container Storage   4.9.8     ocs-operator.v4.9.7   Succeeded
odf-operator.v4.9.8   OpenShift Data Foundation     4.9.8     odf-operator.v4.9.7   Succeeded</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span>を押すと終了できます。</p>
</div>
<div class="paragraph">
<p>リソース <code>csv</code> は <code>clusterserviceversions.operators.coreos.com</code> の短縮です。</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">全てのOperatorの <code>PHASE</code> が <code>Succeeded</code> に変わるまで待って下さい。</div>
変わるまで数分かかる場合があります。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ODF Operatorのインストールが終わると、いくつかの新しいPodが <code>openshift-storage</code> Namespaceに作成されていることが確認できます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n openshift-storage get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                               READY   STATUS    RESTARTS   AGE
noobaa-operator-75847d5b48-krtpt                   1/1     Running   0          5m37s
ocs-metrics-exporter-7f855fc64c-xlc7s              1/1     Running   0          5m35s
ocs-operator-7cdd8cc9f5-khwlg                      1/1     Running   0          5m35s
odf-console-6bb644f8c4-vndfh                       1/1     Running   0          5m49s
odf-operator-controller-manager-5b767b7f4c-6jm2j   2/2     Running   0          5m49s
rook-ceph-operator-54d974474c-k82xz                1/1     Running   0          5m35s</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Openshift Web Console</strong> に戻ってそれでは続いてストレージクラスタを作成します。<br></p>
</div>
<div class="paragraph">
<p><strong>Create StorageSystem</strong> をクリックします。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/OCS4-OCP4-View-Operator.png" alt="Create storage system in openshift-storage namespace">
</div>
<div class="title">Figure 5. Create storage system in openshift-storage namespace</div>
</div>
<div class="paragraph">
<p><code>Create StorageSystem</code> の画面が表示されます。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/OCS4-config-screen-partial1.png" alt="Configure storage system settings">
</div>
<div class="title">Figure 6. Configure storage system settings</div>
</div>
<div class="paragraph">
<p><strong>Backing storage</strong> では <code>Use an existing StorageClass</code> を選択し、<strong>Storage Class</strong> には <code>gp2</code> を指定します。<br>
<strong>Deployment type</strong> では <code>Full deployment</code> を指定します。</p>
</div>
<div class="paragraph">
<p><strong>Next</strong> をクリックします 。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
他のメニューの <code>Create a new StorageClass using local storage devices</code> は、Baremetal方式でインストールしたOCPクラスタでODFを構成する場合や、AWS EBSではないEC2 Instanceに元から存在するデバイスを使ってODFクラスタを構成する場合に使います。<br>
また <code>Connect an external storage platform</code> は、外部ストレージとコントロールプレーンを統一する特殊なケースで使います。
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/OCS4-config-screen-partial2.png" alt="Select capacity and nodes for new storage system">
</div>
<div class="title">Figure 7. Select capacity and nodes for new storage system</div>
</div>
<div class="paragraph">
<p><strong>Select Capacity</strong> では、<code>2 TiB</code> を指定します。</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<strong>ここで選択する Requested Capacity は、将来容量を拡張する際の最小単位として利用されます。</strong><br>
例えば初めに2 TiBを選択した場合は、以降は 2TiB 単位で拡張することになります。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Select nodes</strong> で、ODFクラスタで使うnodeを指定して <strong>Next</strong> をクリックします。
ODF用のラベル <code>cluster.ocs.openshift.io/openshift-storage</code> が付けられたノードは、ここで自動で選択されるようになっています。そのため、はじめから3つのWorkerノードが選択されているはずです。以下のコマンドを実行して、間違いがないことを確認してみましょう。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get nodes --show-labels | grep ocs | cut -d ' ' -f1</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Next</strong> をクリックします 。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/ODF4.9-config-screen-partial3.png" alt="Select encryption and network">
</div>
<div class="title">Figure 8. ODF create a new storage cluster: Security and network</div>
</div>
<div class="paragraph">
<p><strong>Encryption</strong> では、何も選択しません。<br>
クラスタ全体、または部分的な暗号化を利用したい場合は、ここでチェックを入れます。今回の Lab では暗号化はしないので、チェックを外したままで構いません。<br>
（興味のある方は、チェックしてみてどのようなメニューが表示されるか確認されて構いません。<strong>最後はチェックを外すよう注意してください</strong>)</p>
</div>
<div class="paragraph">
<p><strong>Network</strong> では、<code>Default (SDN)</code> を選択します。<br>
Multus CNIを使ってPodで複数のネットワークを使用できる構成になっているOpenShiftクラスタでは、ODFでPublic NetworkとCluster Networkを分離することが可能です。<br>
ここでは一般的な構成である、ネットワークを分離しないODFクラスタを構成するため、<code>Default (SDN)</code> を選択します。</p>
</div>
<div class="paragraph">
<p><strong>Next</strong> をクリックします。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/OCS4-config-screen-partial3.png" alt="Review and create new storage system">
</div>
<div class="title">Figure 9. Review and create new storage system</div>
</div>
<div class="paragraph">
<p>設定した内容をレビューし、問題がなければ <strong>Create StorageSystem</strong> をクリックします。</p>
</div>
<div class="paragraph">
<p>ターミナルウィンドウにすべての <strong>Pods</strong> が <code>Running</code> または <code>Completed</code> と表示されるまでお待ちください。これは5-10分かかります。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch oc -n openshift-storage get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                                              READY   STATUS      RESTARTS   AGE
csi-cephfsplugin-5gmvm                                            3/3     Running     0          7m29s
csi-cephfsplugin-8z6tf                                            3/3     Running     0          7m29s
csi-cephfsplugin-ksznb                                            3/3     Running     0          7m29s
csi-cephfsplugin-lxjl4                                            3/3     Running     0          7m29s
csi-cephfsplugin-provisioner-b99bc4cbd-5r6lr                      6/6     Running     0          7m28s
csi-cephfsplugin-provisioner-b99bc4cbd-92fqb                      6/6     Running     0          7m28s
csi-cephfsplugin-r9kn7                                            3/3     Running     0          7m29s
csi-cephfsplugin-vv44h                                            3/3     Running     0          7m29s
csi-rbdplugin-4528q                                               3/3     Running     0          7m30s
csi-rbdplugin-8qgx2                                               3/3     Running     0          7m30s
csi-rbdplugin-9qrl5                                               3/3     Running     0          7m30s
csi-rbdplugin-dv6kr                                               3/3     Running     0          7m30s
csi-rbdplugin-f2lnk                                               3/3     Running     0          7m30s
csi-rbdplugin-provisioner-58dbf8596d-89nkc                        6/6     Running     0          7m30s
csi-rbdplugin-provisioner-58dbf8596d-crzkr                        6/6     Running     0          7m30s
csi-rbdplugin-z2hkc                                               3/3     Running     0          7m30s
noobaa-core-0                                                     1/1     Running     0          2m39s
noobaa-db-pg-0                                                    1/1     Running     0          2m40s
noobaa-endpoint-864c59cc59-p5bz5                                  1/1     Running     0          85s
noobaa-operator-585b66865d-z7n6d                                  1/1     Running     0          73m
ocs-metrics-exporter-6f7fb77856-hzqxm                             1/1     Running     0          73m
ocs-operator-f5bb58ddf-7ngr8                                      1/1     Running     0          73m
odf-console-87bb59fb4-f9mc2                                       1/1     Running     0          73m
odf-operator-controller-manager-85f6cbddfb-bnqd6                  2/2     Running     0          73m
rook-ceph-crashcollector-639901b7a01a84b64f7e5c4a655e8490-jbd9w   1/1     Running     0          3m58s
rook-ceph-crashcollector-8537d53bc818115d1313e67321d95993-bkhlg   1/1     Running     0          4m6s
rook-ceph-crashcollector-abe3991bcdfa5e2f397ccd4ef3879a78-gz87c   1/1     Running     0          4m5s
rook-ceph-mds-ocs-storagecluster-cephfilesystem-a-cfb7488drfcjl   2/2     Running     0          3m2s
rook-ceph-mds-ocs-storagecluster-cephfilesystem-b-7678d586nlzj7   2/2     Running     0          3m1s
rook-ceph-mgr-a-9b9d56-mk5r7                                      2/2     Running     0          4m6s
rook-ceph-mon-a-74965cfc9f-btt7c                                  2/2     Running     0          7m12s
rook-ceph-mon-b-987b79745-bg9nt                                   2/2     Running     0          4m59s
rook-ceph-mon-c-555d55585-9bf88                                   2/2     Running     0          4m35s
rook-ceph-operator-55b4496c6b-kmlm6                               1/1     Running     0          73m
rook-ceph-osd-0-74cb6855bd-l46rl                                  2/2     Running     0          3m34s
rook-ceph-osd-1-6b4f4cccdf-w7g7w                                  2/2     Running     0          3m33s
rook-ceph-osd-2-64c888b48-gcs4n                                   2/2     Running     0          3m26s
rook-ceph-osd-prepare-ocs-deviceset-gp2-0-data-0wnh5j--1-xhgmf    0/1     Completed   0          4m
rook-ceph-osd-prepare-ocs-deviceset-gp2-1-data-08kht7--1-zw66k    0/1     Completed   0          4m
rook-ceph-osd-prepare-ocs-deviceset-gp2-2-data-0blmfh--1-dzdqk    0/1     Completed   0          3m59s</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span>を押すと終了できます。</p>
</div>
<div class="paragraph">
<p>OperatorとOpenShiftの素晴らしいところは、デプロイされたコンポーネントに関するインテリジェンスをOperatorが内蔵していることです。
また、Operatorは <code>CustomResource</code> を定義します。そのため <code>CustomResource</code> 自体を見ることでステータスを確認することができます。<br>
ODFを例にすると、ODFクラスタをデプロイすると最終的には <code>StorageSystem</code> と <code>StorageCluster</code> のインスタンスが生成されていることが分かります。この <code>StorageSystem</code> と <code>StorageCluster</code> は ODF Operator によって定義された <code>CustomeResource</code> です。</p>
</div>
<div class="paragraph">
<p><code>StorageCluster</code> のステータスは次のようにチェックできます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get storagecluster -n openshift-storage</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Phase</code> のカラムが <code>Ready</code> となっていれば、続けることができます。</p>
</div>
<div class="sect2">
<h3 id="_ストレージダッシュボードの使用"><a class="anchor" href="#_ストレージダッシュボードの使用"></a>ストレージダッシュボードの使用</h3>
<div class="paragraph">
<p>このセクションでは、<strong>OpenShift Web Console</strong> に含まれている、ODF独自のダッシュボードを使ってストレージクラスタのステータスを確認します。<br>
まず、ODF Operatorのインストール後に画面右上に次のようなポップアップが表示されている場合は、<strong>Refersh web console</strong> をクリックして画面を更新してください。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/ODF4.9-refresh-webconsole.png" alt="ODF Dashboard after successful operator installation">
</div>
<div class="title">Figure 10. ODF Dashboard after successful operator installation</div>
</div>
<div class="paragraph">
<p>ダッシュボードは左側のメニューバーから <strong>Storage</strong> &#8594; <strong>OpenShift Data Foundation</strong> とクリックすることでアクセスできます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
ODFのデプロイが完了したばかりの場合、ダッシュボードが完全に表示されるまでに5〜10分かかります。
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocs/OCS-dashboard-healthy.png" alt="Storage Dashboard after successful storage installation">
</div>
<div class="title">Figure 11. Storage Dashboard after successful storage installation</div>
</div>
<div class="paragraph">
<p>ダッシュボードの使用方法の詳細については、 <a href="https://access.redhat.com/documentation/en-us/red_hat_openshift_data_foundation/4.9/html/monitoring_openshift_data_foundation/cluster_health#verifying-openshift-data-foundation-is-healthy_rhodf">ODFモニタリングガイド</a>を参照してください。</p>
</div>
<div class="paragraph">
<p>全てが正常になると、ODFがインストール中に作成した3つの新しい <strong>StorageClass</strong> が使用可能になります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ocs-storagecluster-ceph-rbd</p>
</li>
<li>
<p>ocs-storagecluster-cephfs</p>
</li>
<li>
<p>openshift-storage.noobaa.io</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Storage</strong> メニューの <strong>Storage Classes</strong> を選択することで、これら3つの <strong>StorageClass</strong> が表示されます。<br>
また、以下のコマンドでも確認できます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get storageclasses</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記の3つの <strong>StorageClass</strong> が使用可能であることを確認しましょう。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
MCGは <code>noobaa-core</code> Pod内部の <code>db</code> コンテナで利用するために <code>ocs-storagecluster-ceph-rbd</code> StorageClassを使用してPVCを作成しています。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rook_ceph_toolboxを利用したcephクラスタの確認"><a class="anchor" href="#_rook_ceph_toolboxを利用したcephクラスタの確認"></a>Rook-Ceph toolboxを利用したCephクラスタの確認</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このセクションでは、Rook-Ceph <strong>toolbox</strong> を利用して作成されたCephクラスタに対してcephコマンドを実行し、クラスタ構成を確認します。
Rook-Ceph <strong>toolbox</strong> は手動でデプロイする必要があります。</p>
</div>
<div class="paragraph">
<p>以下のコマンドで <code>OCSInitialization ocsinit</code> を修正します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc patch OCSInitialization ocsinit -n openshift-storage --type json --patch  '[{ "op": "replace", "path": "/spec/enableCephTools", "value": true }]'</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>rook-ceph-tools</code> Pod が <code>Running</code> になれば、次のようにtoolbox Podに入ることができます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">TOOLS_POD=$(oc get pods -n openshift-storage -l app=rook-ceph-tools -o name)
oc rsh -n openshift-storage $TOOLS_POD</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>toolbox</strong> Podに入ったら、次のcephコマンドを実行してみて下さい。これらのコマンドによってCephクラスタの詳細な構成を確認することができます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ceph status</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ceph osd status</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ceph osd tree</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ceph df</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">rados df</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ceph versions</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">出力例:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sh-4.4$ ceph status
  cluster:
    id:     cbeb7c9d-2a30-4646-b5a6-72d5c1db914c
    health: HEALTH_OK

  services:
    mon: 3 daemons, quorum a,b,c (age 19m)
    mgr: a(active, since 19m)
    mds: 1/1 daemons up, 1 hot standby
    osd: 3 osds: 3 up (since 18m), 3 in (since 19m)

  data:
    volumes: 1/1 healthy
    pools:   4 pools, 97 pgs
    objects: 92 objects, 133 MiB
    usage:   249 MiB used, 6.0 TiB / 6 TiB avail
    pgs:     97 active+clean

  io:
    client:   1.2 KiB/s rd, 5.0 KiB/s wr, 2 op/s rd, 0 op/s wr</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="keyseq"><kbd>Ctrl</kbd>+<kbd>D</kbd></span> を押すか、 <code>exit</code> を実行して <strong>toolbox</strong> から出ることができます.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">exit</code></pre>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
